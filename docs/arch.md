alb architecture
===
# 产品目标
alb目的是通过构建一个负载均衡群集动态管理后端反向代理。负载均衡选在HAProxy和Nginx. 通过keepalive保证高可用。云路公司现主要运维工作是在私有云的虚拟机上进行。没有对网络设备的控制能力，撑死了通过vip来做两台主机的高可用。目前负载均衡管理比较混乱。都是通过手工添加的形式分散在各个虚拟机上。为了提高运维效率计划开发负载均衡管理服务`alb` adc load balance.

# 核心概念
## `LBR` Load Balance Record
平台用户所用户的负载均衡资源，一版有两类，一类以三级域名为基础,开放80,443端口的负载均衡记录。如：
```bash
adc.htres.cn, bcd.htres.cn,
```
这类负载均衡资源让用户可以申请自定义的域名通过域名的形式提供负载均衡。好处是IP资源有限。多个域名可以绑定在同一个公网IP上对外提供服务。

另外一类是IP地址端口号的负载均衡资源。如：
```bash
106.75.69.8:1443, 106.75.69.9:7590
```
这样做的好处是端口范围广可以支持很多服务。用户可以绑定独立IP，单独承担外网负载流量，一般高并发应用和大流量用户建议使用绑定IP的方式独占负载均衡资源。阿里等云供应商因为资源丰富，多数以这样的形式对外提供服务。

## `LBP` Load Balance Pool
负载均衡资源池，一般是一组限定端口范围和限定域名范围的记录。组成的资源池。形式如下:
``` bash
106.75.69.9,8000-20000  亦或 [0-9a-Z]{0,1}.htres.cn [0-9a-Z]{1,2}.htres.cn
```
## `LBA` Load Balance Agent
每个LBM由一组`Agent`负责配置。Agent运行在虚拟机上，可以绑定域名，绑定端口并反向代理到后端`RealServer`上

## `LBMC` Load Balance Resource Management Center
负载均衡管理中心，主要负责维护LBP，分配LBR给用户，管理LBA

## `LBC` Load Balance Client
负载均衡客户端，主要负责发送负载均衡请求，在产品中主要表现为，adc中的K8s平台，将带用户信息的负载均衡请求发送给LBMC. 或者实际负载均衡使用者，发送请求到LBMC进行配置。亦或者是其他程序，通过提供的SDK可以代替用户操作负载均衡。
# 功能架构

## LBA
agent负载管理代理服务的，如HAProxy， Nginx等，部署在虚拟主机上。主要功能如下：

1. 负责负载均衡服务的启动停止更改配置

2. 提供API接口让Center来控制

3. 向etcd注册自己，汇报状态

4. 提供metrics向metrics收集器汇报各种监控指标

# LBMC
负载均衡管理中心，主要功能是接收外部负载均衡配置请求，调度agent。主要功能如下：

1. 管理Agent
2. 管理LBP与LBR
3. 接收客户端LBRequest创建修改负载配置
4. 提供一组高可用`KeepAlive`的形式。